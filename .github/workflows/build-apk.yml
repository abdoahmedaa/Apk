name: ðŸš€ Build Enhanced FocusFlow APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx4g

jobs:
  build:
    name: ðŸ“± Build Enhanced APK
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ”§ Make gradlew executable
      run: chmod +x gradlew
      
    - name: âœ… Validate Gradle wrapper
      uses: gradle/wrapper-validation-action@v2
      
    - name: ðŸ§¹ Clean Project
      run: ./gradlew clean --stacktrace
      
    - name: ðŸ” Verify Enhanced Features
      run: |
        echo "ðŸ” Checking enhanced features..."
        echo "ðŸ“Š Total Kotlin files: $(find app/src -name "*.kt" | wc -l)"
        echo "ðŸŽ¨ UI components: $(find app/src -path "*/ui/*" -name "*.kt" | wc -l)"
        echo "ðŸ“ˆ Analytics files: $(find app/src -path "*analytics*" -name "*.kt" | wc -l)"
        echo "ðŸŽ­ Animation files: $(find app/src -path "*animation*" -name "*.kt" | wc -l)"
        echo "âœ… Enhanced features verified!"
        
    - name: ðŸ—ï¸ Build Enhanced Debug APK
      run: |
        echo "ðŸš€ Building FocusFlow Enhanced APK..."
        echo "ðŸ“± Enhanced features included:"
        echo "   âœ… Material 3 Design System"
        echo "   âœ… Advanced Analytics Dashboard"
        echo "   âœ… Enhanced Data Models"
        echo "   âœ… Swipeable UI Components"
        echo "   âœ… Animation Framework"
        echo "   âœ… Productivity Metrics"
        echo ""
        ./gradlew assembleDebug --stacktrace
        
    - name: ðŸ“‹ Verify APK Creation
      run: |
        echo "ðŸ“± APK Build Results:"
        ls -la app/build/outputs/apk/debug/
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "ðŸ“¦ APK Size: $APK_SIZE"
          echo "âœ… Enhanced FocusFlow APK built successfully!"
          
          # Verify APK is valid
          file app/build/outputs/apk/debug/app-debug.apk
        else
          echo "âŒ APK file not found!"
          echo "Available files:"
          find app/build -name "*.apk" 2>/dev/null || echo "No APK files found"
          exit 1
        fi
        
    - name: ðŸ§ª Run Unit Tests
      run: ./gradlew testDebugUnitTest --stacktrace
      continue-on-error: true
      
    - name: ðŸ“¤ Upload Enhanced APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: focusflow-enhanced-apk-${{ github.run_number }}
        path: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/debug/output-metadata.json
        retention-days: 30
        compression-level: 6
        
    - name: ðŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 7
        
    - name: ðŸ“ Build Summary
      if: always()
      run: |
        echo "## ðŸŽ‰ FocusFlow Enhanced Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ¨ Enhanced Features Included" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Material 3 Design System" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Advanced Analytics Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Enhanced Data Models (Tasks, Habits, Analytics)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Swipeable UI Components with Gestures" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Smooth Animation Framework" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Productivity Metrics & Insights" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Pull-to-refresh Functionality" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Haptic Feedback Integration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "### ðŸ“¦ APK Details" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** app-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully Built" >> $GITHUB_STEP_SUMMARY
          echo "- **Download:** Available in Artifacts section" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ APK Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the build logs above for details." >> $GITHUB_STEP_SUMMARY
        fi
