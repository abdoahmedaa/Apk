name: ðŸš€ Build Enhanced FocusFlow APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx4g

jobs:
  build:
    name: ðŸ“± Build Enhanced APK
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ðŸ“¦ Cache Gradle Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: ðŸ”§ Setup Gradle Wrapper
      run: |
        echo "ðŸ” Checking Gradle wrapper files..."
        ls -la gradlew* || echo "gradlew files missing"
        ls -la gradle/wrapper/ || echo "wrapper directory missing"
        
        # Make gradlew executable
        chmod +x gradlew || echo "gradlew not found, will create"
        
        # Verify wrapper files exist
        if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
          echo "âŒ gradle-wrapper.jar missing"
          echo "ðŸ“ Available files in gradle/wrapper/:"
          ls -la gradle/wrapper/ || echo "Directory doesn't exist"
          
          # Create wrapper directory if missing
          mkdir -p gradle/wrapper
          
          # Download gradle wrapper jar directly
          echo "â¬‡ï¸ Downloading gradle-wrapper.jar..."
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            https://github.com/gradle/gradle/raw/v8.5.0/gradle/wrapper/gradle-wrapper.jar
          
          echo "âœ… Downloaded gradle-wrapper.jar"
        fi
        
        # Verify wrapper properties
        if [ ! -f gradle/wrapper/gradle-wrapper.properties ]; then
          echo "âŒ gradle-wrapper.properties missing, creating..."
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
        networkTimeout=10000
        validateDistributionUrl=true
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
          echo "âœ… Created gradle-wrapper.properties"
        fi
        
        # Create gradlew if missing
        if [ ! -f gradlew ]; then
          echo "âŒ gradlew missing, creating..."
          cat > gradlew << 'EOF'
        #!/bin/sh
        
        DEFAULT_JVM_OPTS='"-Xmx64m" "-Xms64m"'
        APP_NAME="Gradle"
        APP_BASE_NAME=`basename "$0"`
        
        # Resolve links: $0 may be a link
        PRG="$0"
        while [ -h "$PRG" ] ; do
            ls=`ls -ld "$PRG"`
            link=`expr "$ls" : '.*-> \(.*\)$'`
            if expr "$link" : '/.*' > /dev/null; then
                PRG="$link"
            else
                PRG=`dirname "$PRG"`"/$link"
            fi
        done
        
        SAVED="`pwd`"
        cd "`dirname \"$PRG\"`/" >/dev/null
        APP_HOME="`pwd -P`"
        cd "$SAVED" >/dev/null
        
        CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
        
        # Determine the Java command to use to start the JVM.
        if [ -n "$JAVA_HOME" ] ; then
            if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
                # IBM's JDK on AIX uses strange locations for the executables
                JAVACMD="$JAVA_HOME/jre/sh/java"
            else
                JAVACMD="$JAVA_HOME/bin/java"
            fi
            if [ ! -x "$JAVACMD" ] ; then
                die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME
        
        Please set the JAVA_HOME variable in your environment to match the
        location of your Java installation."
            fi
        else
            JAVACMD="java"
            which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
        
        Please set the JAVA_HOME variable in your environment to match the
        location of your Java installation."
        fi
        
        # Collect all arguments for the java command.
        set -- \
                "-Dorg.gradle.appname=$APP_BASE_NAME" \
                -classpath "$CLASSPATH" \
                org.gradle.wrapper.GradleWrapperMain \
                "$@"
        
        exec "$JAVACMD" "$@"
        EOF
          chmod +x gradlew
          echo "âœ… Created gradlew"
        fi
        
        echo "ðŸ” Final verification:"
        ls -la gradlew*
        ls -la gradle/wrapper/
        
    - name: âœ… Test Gradle Wrapper
      run: |
        echo "ðŸ§ª Testing Gradle wrapper..."
        ./gradlew --version
        echo "âœ… Gradle wrapper working!"
        
    - name: ðŸ§¹ Clean Project
      run: |
        echo "ðŸ§¹ Cleaning project..."
        ./gradlew clean --stacktrace
        echo "âœ… Clean completed!"
        
    - name: ðŸ” Verify Enhanced Features
      run: |
        echo "ðŸ” Checking enhanced features..."
        echo "ðŸ“Š Total Kotlin files: $(find app/src -name "*.kt" 2>/dev/null | wc -l)"
        echo "ðŸŽ¨ UI components: $(find app/src -path "*/ui/*" -name "*.kt" 2>/dev/null | wc -l)"
        echo "ðŸ“ˆ Analytics files: $(find app/src -path "*analytics*" -name "*.kt" 2>/dev/null | wc -l)"
        echo "ðŸŽ­ Animation files: $(find app/src -path "*animation*" -name "*.kt" 2>/dev/null | wc -l)"
        echo "ðŸ“± Enhanced components: $(find app/src -path "*enhanced*" -name "*.kt" 2>/dev/null | wc -l)"
        echo "âœ… Enhanced features verified!"
        
    - name: ðŸ—ï¸ Build Enhanced Debug APK
      run: |
        echo "ðŸš€ Building FocusFlow Enhanced APK..."
        echo ""
        echo "ðŸ“± Enhanced features included:"
        echo "   âœ… Material 3 Design System"
        echo "   âœ… Advanced Analytics Dashboard"
        echo "   âœ… Enhanced Data Models"
        echo "   âœ… Swipeable UI Components"
        echo "   âœ… Animation Framework"
        echo "   âœ… Productivity Metrics"
        echo "   âœ… Pull-to-refresh Functionality"
        echo "   âœ… Haptic Feedback Integration"
        echo ""
        echo "ðŸ”¨ Starting build process..."
        ./gradlew assembleDebug --stacktrace --info
        
    - name: ðŸ“‹ Verify APK Creation
      run: |
        echo "ðŸ“± APK Build Results:"
        echo "ðŸ“ Checking output directory..."
        ls -la app/build/outputs/apk/debug/ || echo "âŒ APK directory not found"
        
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          APK_BYTES=$(stat -c%s app/build/outputs/apk/debug/app-debug.apk)
          echo ""
          echo "âœ… SUCCESS! Enhanced FocusFlow APK built successfully!"
          echo "ðŸ“¦ APK Size: $APK_SIZE ($APK_BYTES bytes)"
          echo "ðŸ“ Location: app/build/outputs/apk/debug/app-debug.apk"
          echo ""
          
          # Verify APK is valid Android package
          file app/build/outputs/apk/debug/app-debug.apk
          
          # Show APK details
          echo "ðŸ“‹ APK Details:"
          ls -lh app/build/outputs/apk/debug/app-debug.apk
          
        else
          echo "âŒ APK file not found!"
          echo "ðŸ” Searching for any APK files..."
          find app/build -name "*.apk" 2>/dev/null || echo "No APK files found anywhere"
          echo ""
          echo "ðŸ“ Available files in output directory:"
          find app/build/outputs -type f 2>/dev/null || echo "No output files found"
          exit 1
        fi
        
    - name: ðŸ§ª Run Unit Tests
      run: |
        echo "ðŸ§ª Running unit tests..."
        ./gradlew testDebugUnitTest --stacktrace
        echo "âœ… Tests completed!"
      continue-on-error: true
      
    - name: ðŸ“¤ Upload Enhanced APK
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: focusflow-enhanced-apk-${{ github.run_number }}
        path: |
          app/build/outputs/apk/debug/app-debug.apk
          app/build/outputs/apk/debug/output-metadata.json
        retention-days: 30
        compression-level: 6
        
    - name: ðŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          app/build/reports/tests/
          app/build/test-results/
        retention-days: 7
        
    - name: ðŸ“ Build Summary
      if: always()
      run: |
        echo "## ðŸŽ‰ FocusFlow Enhanced Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ¨ Enhanced Features Included" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Material 3 Design System" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Advanced Analytics Dashboard" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Enhanced Data Models (Tasks, Habits, Analytics)" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Swipeable UI Components with Gestures" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Smooth Animation Framework" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Productivity Metrics & Insights" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Pull-to-refresh Functionality" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Haptic Feedback Integration" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          APK_SIZE=$(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)
          echo "### ðŸ“¦ APK Details" >> $GITHUB_STEP_SUMMARY
          echo "- **File:** app-debug.apk" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $APK_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** âœ… Successfully Built" >> $GITHUB_STEP_SUMMARY
          echo "- **Download:** Available in Artifacts section below" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Ready to Install!" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the APK from Artifacts section" >> $GITHUB_STEP_SUMMARY
          echo "2. Enable 'Unknown sources' on your Android device" >> $GITHUB_STEP_SUMMARY
          echo "3. Install and enjoy your enhanced FocusFlow app!" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ APK Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the build logs above for details." >> $GITHUB_STEP_SUMMARY
        fi
